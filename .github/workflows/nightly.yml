name: Nightly Build

on:
  repository_dispatch:
    types: [nightly]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (commit SHA or branch)"
        required: true
        type: string

concurrency:
  group: nightly-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare Nightly Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_id: ${{ steps.release.outputs.id }}
      nightly_version: ${{ steps.version.outputs.nightly_version }}
      ref: ${{ steps.params.outputs.ref }}
      release_body: ${{ steps.changelog.outputs.notes }}
    steps:
      - name: Get build parameters
        id: params
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ref=${{ github.event.client_payload.ref }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout private source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: Voice-Wise/VoiceWise
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: ${{ steps.params.outputs.ref }}
          fetch-depth: 0
          fetch-tags: true

      - name: Compute nightly version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          BASE_VERSION="$(python - <<'PY'
          import json
          from pathlib import Path
          v = json.loads(Path("package.json").read_text(encoding="utf-8")).get("version","").strip()
          print(v)
          PY
          )"

          if [[ ! "${BASE_VERSION}" =~ ^[0-9]+\\.[0-9]+\\.[0-9]+$ ]]; then
            echo "Invalid base version in package.json: ${BASE_VERSION}" >&2
            exit 1
          fi

          MAJOR="${BASE_VERSION%%.*}"
          REST="${BASE_VERSION#*.}"
          MINOR="${REST%%.*}"
          PATCH="${REST#*.}"

          NEXT_PATCH="$((PATCH + 1))"
          DATE_UTC="$(date -u +%Y%m%d)"
          SHA="$(git rev-parse --short=7 HEAD)"

          NIGHTLY_VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-nightly.${DATE_UTC}.${SHA}"
          echo "nightly_version=${NIGHTLY_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Nightly version: ${NIGHTLY_VERSION}"

      - name: Generate nightly changelog from commits
        id: changelog
        shell: bash
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        run: |
          set -euo pipefail

          CURRENT_REF="${{ steps.params.outputs.ref }}"
          LAST_STABLE_TAG="$(git describe --tags --abbrev=0 --match 'v*' 2>/dev/null || true)"

          if [[ -n "${LAST_STABLE_TAG}" ]]; then
            RANGE="${LAST_STABLE_TAG}..HEAD"
            COMPARE_URL="https://github.com/Voice-Wise/VoiceWise/compare/${LAST_STABLE_TAG}...${CURRENT_REF}"
          else
            RANGE="HEAD"
            COMPARE_URL=""
          fi

          COMMITS="$(git log --reverse --no-merges --format='%s' ${RANGE} | grep -v '^chore(release):' || true)"

          HEADER="## Nightly Build\n\n- Version: v${{ steps.version.outputs.nightly_version }}\n- Ref: ${CURRENT_REF}\n"
          if [[ -n "${COMPARE_URL}" ]]; then
            HEADER="${HEADER}- Compare: ${COMPARE_URL}\n"
          fi

          if [[ -z "$COMMITS" ]]; then
            NOTES="${HEADER}\n\n## Changelog\n\n- No changes.\n"
          else
            PROMPT="You are generating release notes for a NIGHTLY build. Based on the following git commit messages, generate a concise and user-friendly changelog in BOTH Chinese (Simplified) and English. First output the Chinese version, then add a horizontal rule (---), then output the English version. Group changes by category (e.g., âœ¨ æ–°åŠŸèƒ½/New Features, ðŸ› é—®é¢˜ä¿®å¤/Bug Fixes, âš¡ æ€§èƒ½ä¼˜åŒ–/Performance, ðŸ”§ å…¶ä»–æ”¹è¿›/Other Improvements). Only include meaningful changes, skip trivial commits. Use clear, non-technical language. Output ONLY the changelog content in markdown format without any preamble.\n\nCommit messages:\n$COMMITS"

            RESPONSE=$(curl -s --max-time 30 "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions" \
              -H "Authorization: Bearer $DASHSCOPE_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg prompt "$PROMPT" '{
                "model": "qwen-plus-latest",
                "messages": [{"role": "user", "content": $prompt}],
                "max_tokens": 1024
              }')" 2>/dev/null || echo "{}")

            CHANGELOG=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty' 2>/dev/null || true)

            if [[ -z "$CHANGELOG" ]]; then
              NOTES="${HEADER}\n\n## Changelog\n\nSee source repository for details.\n"
            else
              NOTES="${HEADER}\n\n## Changelog\n\n${CHANGELOG}\n"
            fi
          fi

          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub prerelease (nightly)
        id: release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          tag_name: v${{ steps.version.outputs.nightly_version }}
          name: VoiceWise Nightly v${{ steps.version.outputs.nightly_version }}
          body: ${{ steps.changelog.outputs.notes }}
          generate_release_notes: false
          draft: false
          prerelease: true

  package:
    name: Package (${{ matrix.name }})
    needs: [prepare]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macOS (aarch64)
            os: macos-latest
            target: aarch64-apple-darwin
            tauri_args: --target aarch64-apple-darwin
            artifact_name: voicewise-nightly-macos-aarch64-apple-darwin
            artifact_paths: |
              src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
              src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz*

          - name: macOS (x86_64)
            os: macos-latest
            target: x86_64-apple-darwin
            tauri_args: --target x86_64-apple-darwin
            artifact_name: voicewise-nightly-macos-x86_64-apple-darwin
            artifact_paths: |
              src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
              src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz*

          - name: Windows (x86_64)
            os: windows-latest
            target: x86_64-pc-windows-msvc
            tauri_args: --target x86_64-pc-windows-msvc --bundles nsis
            artifact_name: voicewise-nightly-windows-x86_64-pc-windows-msvc
            artifact_paths: |
              src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe*

    steps:
      - name: Checkout private source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: Voice-Wise/VoiceWise
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@8f24390df009a496891208e5e36b8a1de1f45135 # v2.0.2
        with:
          bun-version: "1.3.2"

      - name: Cache Bun
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-${{ matrix.target }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: |
            src-tauri -> target

      - name: Run Rust tests
        run: bun run test:rust

      - name: Patch version for nightly build
        shell: bash
        env:
          NIGHTLY_VERSION: ${{ needs.prepare.outputs.nightly_version }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import json, os, re
          from pathlib import Path

          version = os.environ["NIGHTLY_VERSION"].strip()
          if not version:
              raise SystemExit("Missing NIGHTLY_VERSION")

          pkg_path = Path("package.json")
          pkg = json.loads(pkg_path.read_text(encoding="utf-8"))
          pkg["version"] = version
          pkg_path.write_text(json.dumps(pkg, ensure_ascii=False, indent=2) + "\n", encoding="utf-8")

          tauri_path = Path("src-tauri/tauri.conf.json")
          tauri = json.loads(tauri_path.read_text(encoding="utf-8"))
          tauri["version"] = version
          tauri_path.write_text(json.dumps(tauri, ensure_ascii=False, indent=2) + "\n", encoding="utf-8")

          cargo_path = Path("src-tauri/Cargo.toml")
          content = cargo_path.read_text(encoding="utf-8")
          pattern = r'(^\\[package\\].*?^version\\s*=\\s*\")[^\"]*(\"\\s*$)'
          new_content, count = re.subn(pattern, rf"\\g<1>{version}\\g<2>", content, count=1, flags=re.MULTILINE | re.DOTALL)
          if count == 0:
              raise SystemExit("Failed to patch Cargo.toml version")
          cargo_path.write_text(new_content, encoding="utf-8", newline="\\n")
          PY

      - name: Install NSIS (Windows)
        if: ${{ runner.os == 'Windows' }}
        run: |
          choco install nsis -y --no-progress
          if (Test-Path 'C:\Program Files (x86)\NSIS') {
            'C:\Program Files (x86)\NSIS' | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } elseif (Test-Path 'C:\Program Files\NSIS') {
            'C:\Program Files\NSIS' | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

      - name: Build + upload assets (macOS)
        if: ${{ runner.os == 'macOS' }}
        uses: tauri-apps/tauri-action@v0.6.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tauriScript: "bun run tauri"
          tagName: v${{ needs.prepare.outputs.nightly_version }}
          releaseId: ${{ needs.prepare.outputs.release_id }}
          releaseBody: ""
          args: ${{ matrix.tauri_args }}
          assetNamePattern: "[name]_[version]_[platform]_[arch][ext]"

      - name: Build + upload assets (Windows)
        if: ${{ runner.os == 'Windows' }}
        uses: tauri-apps/tauri-action@v0.6.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tauriScript: "bun run tauri"
          tagName: v${{ needs.prepare.outputs.nightly_version }}
          releaseId: ${{ needs.prepare.outputs.release_id }}
          releaseBody: ""
          args: ${{ matrix.tauri_args }}
          assetNamePattern: "[name]_[version]_[platform]_[arch][ext]"

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_paths }}
          if-no-files-found: error

  publish-nightly-manifests:
    name: Publish Nightly Manifests
    needs: [prepare, package]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout release repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: main
          fetch-depth: 0

      - name: Generate nightly updater manifests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          python scripts/generate-updater-manifests.py \
            --owner "Voice-Wise" \
            --repo "release" \
            --tag "v${{ needs.prepare.outputs.nightly_version }}" \
            --out-dir "." \
            --channel nightly \
            --format scoped-target

      - name: Commit + push manifests
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add latest-*-nightly-*.json
          if git diff --cached --quiet; then
            echo "No manifest changes."
            exit 0
          fi

          git commit -m "chore(nightly): update manifests for v${{ needs.prepare.outputs.nightly_version }}"
          git push origin HEAD:main

