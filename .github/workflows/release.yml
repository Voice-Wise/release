name: Release Build

on:
  repository_dispatch:
    types: [release]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to build (tag or branch)"
        required: true
        type: string
      version:
        description: "Version to release (e.g., 0.1.0)"
        required: true
        type: string

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_body: ${{ steps.changelog.outputs.notes }}
      version: ${{ steps.params.outputs.version }}
      ref: ${{ steps.params.outputs.ref }}
    steps:
      - name: Get build parameters
        id: params
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ref=${{ github.event.client_payload.ref }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout private source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: Voice-Wise/VoiceWise
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: ${{ steps.params.outputs.ref }}
          fetch-depth: 0
          fetch-tags: true

      - name: Verify stable tag + version consistency
        shell: bash
        run: |
          set -euo pipefail

          python - <<'PY'
          import os
          import json
          import re
          import tomllib
          from pathlib import Path

          tag = os.environ.get("BUILD_REF", "")
          if not re.fullmatch(r"v\d+\.\d+\.\d+", tag):
              raise SystemExit(f"Expected stable tag vX.Y.Z, got: {tag}")

          expected = tag.removeprefix("v")
          pkg_version = json.loads(Path("package.json").read_text(encoding="utf-8"))["version"]
          tauri_version = json.loads(Path("src-tauri/tauri.conf.json").read_text(encoding="utf-8"))["version"]
          cargo_version = tomllib.loads(Path("src-tauri/Cargo.toml").read_text(encoding="utf-8"))["package"]["version"]

          versions = {
              "package.json": pkg_version,
              "src-tauri/tauri.conf.json": tauri_version,
              "src-tauri/Cargo.toml": cargo_version,
          }

          mismatch = {k: v for k, v in versions.items() if v != expected}
          if mismatch:
              joined = ", ".join(f"{k}={v}" for k, v in mismatch.items())
              raise SystemExit(f"Version mismatch: tag={expected}, {joined}")
          print(f"Version OK: {expected}")
          PY
        env:
          BUILD_REF: ${{ steps.params.outputs.ref }}

      - name: Generate changelog from commits
        id: changelog
        shell: bash
        env:
          DASHSCOPE_API_KEY: ${{ secrets.DASHSCOPE_API_KEY }}
        run: |
          set -euo pipefail

          CURRENT_TAG="${{ steps.params.outputs.ref }}"
          PREV_TAG="$(git describe --tags --abbrev=0 --match 'v*' "${CURRENT_TAG}^" 2>/dev/null || true)"

          if [[ -n "${PREV_TAG}" ]]; then
            RANGE="${PREV_TAG}..HEAD"
            COMPARE_URL="https://github.com/Voice-Wise/VoiceWise/compare/${PREV_TAG}...${CURRENT_TAG}"
          else
            RANGE="HEAD"
            COMPARE_URL=""
          fi

          # Get commit messages
          COMMITS="$(git log --reverse --no-merges --format='%s' ${RANGE} | grep -v '^chore(release):' || true)"

          if [[ -z "$COMMITS" ]]; then
            NOTES="## Changelog

          - No changes.
          "
          else
            # Build the prompt
            PROMPT="Based on the following git commit messages, generate a concise and user-friendly changelog in BOTH Chinese (Simplified) and English. First output the Chinese version, then add a horizontal rule (---), then output the English version. Group changes by category (e.g., 鉁?鏂板姛鑳?New Features, 馃悰 闂淇/Bug Fixes, 鈿?鎬ц兘浼樺寲/Performance, 馃敡 鍏朵粬鏀硅繘/Other Improvements). Only include meaningful changes, skip trivial commits. Use clear, non-technical language. Output ONLY the changelog content in markdown format without any preamble.

          Commit messages:
          $COMMITS"

            # Call DashScope API
            RESPONSE=$(curl -s --max-time 30 "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions" \
              -H "Authorization: Bearer $DASHSCOPE_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg prompt "$PROMPT" '{
                "model": "qwen-plus-latest",
                "messages": [{"role": "user", "content": $prompt}],
                "max_tokens": 1024
              }')" 2>/dev/null || echo "{}")

            CHANGELOG=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty' 2>/dev/null || true)

            if [[ -z "$CHANGELOG" ]]; then
              # Fallback to generic message (don't expose raw commit messages)
              NOTES="## Changelog

          See release for details. / 璇﹁鍙戝竷璇存槑銆?
          "
            else
              NOTES="## Changelog

          $CHANGELOG
          "
            fi
          fi

          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

  test:
    name: Test (${{ matrix.name }})
    needs: [prepare]
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macOS (aarch64)
            os: macos-latest
            target: aarch64-apple-darwin

          - name: macOS (x86_64)
            os: macos-latest
            target: x86_64-apple-darwin

          - name: Windows (x86_64)
            os: windows-latest
            target: x86_64-pc-windows-msvc

    steps:
      - name: Checkout private source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: Voice-Wise/VoiceWise
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Enable git long paths (Windows)
        if: ${{ runner.os == 'Windows' }}
        run: git config --system core.longpaths true

      - name: "Optimize I/O for Windows (use D: drive)"
        if: ${{ runner.os == 'Windows' }}
        shell: pwsh
        run: |
          $cargoHome = "D:/a/_cargo"
          $cargoTargetDir = "D:/a/_cargo-target"
          $bunCache = "D:/a/_bun-cache"
          New-Item -ItemType Directory -Force -Path $cargoHome | Out-Null
          New-Item -ItemType Directory -Force -Path $cargoTargetDir | Out-Null
          New-Item -ItemType Directory -Force -Path $bunCache | Out-Null
          echo "CARGO_HOME=$cargoHome" >> $env:GITHUB_ENV
          echo "CARGO_TARGET_DIR=$cargoTargetDir" >> $env:GITHUB_ENV
          echo "BUN_INSTALL_CACHE_DIR=$bunCache" >> $env:GITHUB_ENV

      - name: Setup Bun
        uses: oven-sh/setup-bun@8f24390df009a496891208e5e36b8a1de1f45135 # v2.0.2
        with:
          bun-version: "1.3.2"

      - name: Cache Bun
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: |
            ~/.bun/install/cache
            D:/a/_bun-cache
          key: ${{ runner.os }}-${{ matrix.target }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run FE tests
        run: bun run test:fe

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: |
            src-tauri -> target
          env-vars: |
            CARGO_HOME
            CARGO_TARGET_DIR

      - name: Run Rust tests
        run: bun run test:rust

  create-release:
    name: Create Release
    needs: [prepare, test]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_id: ${{ steps.release.outputs.id }}
      version: ${{ needs.prepare.outputs.version }}
      ref: ${{ needs.prepare.outputs.ref }}
    steps:
      - name: Create GitHub release
        id: release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: VoiceWise v${{ needs.prepare.outputs.version }}
          body: ${{ needs.prepare.outputs.release_body }}
          generate_release_notes: false
          draft: false
          prerelease: false

  package:
    name: Package (${{ matrix.name }})
    needs: [create-release]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: write
    env:
      SENTRY_RELEASE: voicewise@${{ needs.create-release.outputs.version }}
      SENTRY_DIST: stable-${{ github.run_number }}-${{ github.run_attempt }}
      VITE_SENTRY_RELEASE: voicewise@${{ needs.create-release.outputs.version }}
      VITE_SENTRY_DIST: stable-${{ github.run_number }}-${{ github.run_attempt }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: macOS (aarch64)
            os: macos-latest
            target: aarch64-apple-darwin
            tauri_args: --target aarch64-apple-darwin
            artifact_name: voicewise-macos-aarch64-apple-darwin
            artifact_paths: |
              src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
              src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz*

          - name: macOS (x86_64)
            os: macos-latest
            target: x86_64-apple-darwin
            tauri_args: --target x86_64-apple-darwin
            artifact_name: voicewise-macos-x86_64-apple-darwin
            artifact_paths: |
              src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
              src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz*

          - name: Windows (x86_64)
            os: windows-latest
            target: x86_64-pc-windows-msvc
            tauri_args: --target x86_64-pc-windows-msvc --bundles nsis
            artifact_name: voicewise-windows-x86_64-pc-windows-msvc
            artifact_paths: |
              src-tauri/target/x86_64-pc-windows-msvc/release/bundle/nsis/*.exe*

    steps:
      - name: Checkout private source code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: Voice-Wise/VoiceWise
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: ${{ needs.create-release.outputs.ref }}

      - name: Enable git long paths (Windows)
        if: ${{ runner.os == 'Windows' }}
        run: git config --system core.longpaths true

      - name: "Optimize I/O for Windows (use D: drive)"
        if: ${{ runner.os == 'Windows' }}
        shell: pwsh
        run: |
          $cargoHome = "D:/a/_cargo"
          $cargoTargetDir = "D:/a/_cargo-target"
          $bunCache = "D:/a/_bun-cache"
          New-Item -ItemType Directory -Force -Path $cargoHome | Out-Null
          New-Item -ItemType Directory -Force -Path $cargoTargetDir | Out-Null
          New-Item -ItemType Directory -Force -Path $bunCache | Out-Null
          echo "CARGO_HOME=$cargoHome" >> $env:GITHUB_ENV
          echo "CARGO_TARGET_DIR=$cargoTargetDir" >> $env:GITHUB_ENV
          echo "BUN_INSTALL_CACHE_DIR=$bunCache" >> $env:GITHUB_ENV

      - name: Setup Bun
        uses: oven-sh/setup-bun@8f24390df009a496891208e5e36b8a1de1f45135 # v2.0.2
        with:
          bun-version: "1.3.2"

      - name: Cache Bun
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: |
            ~/.bun/install/cache
            D:/a/_bun-cache
          key: ${{ runner.os }}-${{ matrix.target }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6 # v2.7.8
        with:
          workspaces: |
            src-tauri -> target
          env-vars: |
            CARGO_HOME
            CARGO_TARGET_DIR

      - name: Install NSIS (Windows)
        if: ${{ runner.os == 'Windows' }}
        run: |
          choco install nsis -y --no-progress
          if (Test-Path 'C:\Program Files (x86)\NSIS') {
            'C:\Program Files (x86)\NSIS' | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } elseif (Test-Path 'C:\Program Files\NSIS') {
            'C:\Program Files\NSIS' | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

      - name: Import Apple code signing cert (early)
        if: ${{ runner.os == 'macOS' }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        shell: bash
        run: |
          set -euo pipefail

          KEYCHAIN_PASSWORD="$(openssl rand -base64 32)"
          KEYCHAIN_PATH="$RUNNER_TEMP/voicewise-build.keychain-db"
          CERT_PATH="$RUNNER_TEMP/apple_cert.p12"

          export CERT_PATH
          python3 - <<'PY'
          import base64, os, pathlib

          b64 = os.environ["APPLE_CERTIFICATE"]
          b64 = "".join(b64.split())
          data = base64.b64decode(b64)
          pathlib.Path(os.environ["CERT_PATH"]).write_bytes(data)
          PY

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$APPLE_CERTIFICATE_PASSWORD" -A -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      - name: Build + upload assets (macOS)
        if: ${{ runner.os == 'macOS' }}
        uses: tauri-apps/tauri-action@v0.6.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tauriScript: "bun run tauri"
          tagName: v${{ needs.create-release.outputs.version }}
          releaseId: ${{ needs.create-release.outputs.release_id }}
          releaseBody: ""
          args: ${{ matrix.tauri_args }}
          assetNamePattern: "[name]_[version]_[platform]_[arch][ext]"

      - name: Build + upload assets (Windows)
        if: ${{ runner.os == 'Windows' }}
        uses: tauri-apps/tauri-action@v0.6.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tauriScript: "bun run tauri"
          tagName: v${{ needs.create-release.outputs.version }}
          releaseId: ${{ needs.create-release.outputs.release_id }}
          releaseBody: ""
          args: ${{ matrix.tauri_args }}
          assetNamePattern: "[name]_[version]_[platform]_[arch][ext]"

      - name: Collect debug symbols (macOS)
        if: ${{ runner.os == 'macOS' }}
        shell: bash
        run: |
          set -euo pipefail
          OUTPUT_DIR="$RUNNER_TEMP/sentry-debug/${{ matrix.target }}"
          SEARCH_ROOT="src-tauri/target/${{ matrix.target }}/release"
          mkdir -p "$OUTPUT_DIR"
          touch "$OUTPUT_DIR/.keep"

          if [[ -d "$SEARCH_ROOT" ]]; then
            while IFS= read -r -d '' symbol_dir; do
              cp -R "$symbol_dir" "$OUTPUT_DIR/"
            done < <(find "$SEARCH_ROOT" -type d -name '*.dSYM' -print0)
          fi

      - name: Collect debug symbols (Windows)
        if: ${{ runner.os == 'Windows' }}
        shell: pwsh
        run: |
          $outputDir = Join-Path $env:RUNNER_TEMP "sentry-debug/${{ matrix.target }}"
          New-Item -ItemType Directory -Force -Path $outputDir | Out-Null
          New-Item -ItemType File -Force -Path (Join-Path $outputDir ".keep") | Out-Null

          $searchRoots = @(
            "src-tauri/target/${{ matrix.target }}/release",
            "D:/a/_cargo-target/${{ matrix.target }}/release"
          )

          foreach ($root in $searchRoots) {
            if (Test-Path $root) {
              Get-ChildItem -Path $root -Filter *.pdb -Recurse -File -ErrorAction SilentlyContinue | ForEach-Object {
                Copy-Item -Path $_.FullName -Destination $outputDir -Force
              }
            }
          }

      - name: Upload Sentry debug symbols artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sentry-debug-${{ matrix.target }}
          path: ${{ runner.temp }}/sentry-debug/${{ matrix.target }}
          if-no-files-found: warn

      - name: Upload Sentry sourcemap artifact
        if: ${{ matrix.target == 'aarch64-apple-darwin' }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: sentry-dist
          path: dist
          if-no-files-found: error

      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_paths }}
          if-no-files-found: error

  sentry-release:
    name: Upload Sentry Assets
    needs: [create-release, package]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout release repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Download Sentry sourcemap artifact
        uses: actions/download-artifact@v4
        with:
          name: sentry-dist
          path: ${{ runner.temp }}/sentry/dist

      - name: Download Sentry debug artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: sentry-debug-*
          path: ${{ runner.temp }}/sentry/debug
          merge-multiple: true

      - name: Upload source map and debug symbols to Sentry
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_RELEASE: voicewise@${{ needs.create-release.outputs.version }}
          SENTRY_DIST: stable-${{ github.run_number }}-${{ github.run_attempt }}
          SENTRY_SOURCEMAP_DIR: ${{ runner.temp }}/sentry/dist
          SENTRY_DEBUG_ROOT: ${{ runner.temp }}/sentry/debug
        run: |
          bash scripts/upload-sentry-release-assets.sh

  publish-manifest:
    name: Publish Stable Manifest
    needs: [create-release, package, sentry-release]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout release repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: main

      - name: Generate combined manifest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          python scripts/generate-updater-manifests.py \
            --owner "Voice-Wise" \
            --repo "release" \
            --tag "v${{ needs.create-release.outputs.version }}" \
            --out-dir "." \
            --channel stable \
            --format combined

      - name: Upload manifest to versioned release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "v${{ needs.create-release.outputs.version }}" \
            latest.json --clobber

      - name: Update stable tag release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ needs.create-release.outputs.version }}"

          # Delete existing stable release if exists
          gh release delete stable --yes --cleanup-tag 2>/dev/null || true

          # Create new stable release pointing to the same tag
          gh release create stable \
            --target "v${VERSION}" \
            --title "VoiceWise Latest Stable (v${VERSION})" \
            --notes "Latest stable release: v${VERSION}" \
            latest.json
