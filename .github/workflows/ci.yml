name: CI (Cross-Repo)

on:
  repository_dispatch:
    types: [ci]
  workflow_dispatch:
    inputs:
      sha:
        description: "Commit SHA to test"
        required: true
        type: string
      ref:
        description: "Git ref (branch name)"
        required: false
        default: "master"
        type: string

concurrency:
  group: ci-${{ github.event.client_payload.sha || github.event.inputs.sha }}
  cancel-in-progress: true

jobs:
  ci:
    name: Run CI Tests
    runs-on: macos-latest
    steps:
      - name: Get parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "sha=${{ github.event.client_payload.sha }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.event.client_payload.ref }}" >> $GITHUB_OUTPUT
            echo "sender_repo=${{ github.event.client_payload.sender_repo }}" >> $GITHUB_OUTPUT
          else
            echo "sha=${{ github.event.inputs.sha }}" >> $GITHUB_OUTPUT
            echo "ref=${{ github.event.inputs.ref }}" >> $GITHUB_OUTPUT
            echo "sender_repo=Voice-Wise/VoiceWise" >> $GITHUB_OUTPUT
          fi

      - name: Set commit status (pending)
        env:
          GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ steps.params.outputs.sender_repo }}/statuses/${{ steps.params.outputs.sha }}" \
            -d '{
              "state": "pending",
              "target_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "description": "CI is running...",
              "context": "ci/cross-repo"
            }'

      - name: Checkout private source code
        uses: actions/checkout@v4
        with:
          repository: Voice-Wise/VoiceWise
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          ref: ${{ steps.params.outputs.sha }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.2"

      - name: Cache Bun
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Setup Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            src-tauri -> target

      - name: Run Rust tests
        run: bun run test:rust

      - name: Run frontend unit tests
        run: bun run test:fe

      - name: Build frontend
        run: bun run build

      - name: Set commit status (success)
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ steps.params.outputs.sender_repo }}/statuses/${{ steps.params.outputs.sha }}" \
            -d '{
              "state": "success",
              "target_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "description": "CI passed",
              "context": "ci/cross-repo"
            }'

      - name: Set commit status (failure)
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ steps.params.outputs.sender_repo }}/statuses/${{ steps.params.outputs.sha }}" \
            -d '{
              "state": "failure",
              "target_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "description": "CI failed",
              "context": "ci/cross-repo"
            }'
